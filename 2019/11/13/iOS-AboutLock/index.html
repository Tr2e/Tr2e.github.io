<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="iOS," />










<meta name="description" content="å‰è¨€å¯¹äºiOSä¸­å„ç§é”çš„å­¦ä¹ æ€»ç»“ï¼Œä¾›æ—¥åæŸ¥é˜…">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS-å…³äºé”çš„æ€»ç»“">
<meta property="og:url" content="http://yoursite.com/2019/11/13/iOS-AboutLock/index.html">
<meta property="og:site_name" content="Tr2e&#39;s Blog">
<meta property="og:description" content="å‰è¨€å¯¹äºiOSä¸­å„ç§é”çš„å­¦ä¹ æ€»ç»“ï¼Œä¾›æ—¥åæŸ¥é˜…">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/1742463-2acd56eaea585c78.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/1742463-ae8eb41b371e5c62.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="article:published_time" content="2019-11-13T14:18:18.000Z">
<meta property="article:modified_time" content="2020-03-28T03:50:18.183Z">
<meta property="article:author" content="Tr2e">
<meta property="article:tag" content="iOS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://upload-images.jianshu.io/upload_images/1742463-2acd56eaea585c78.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/11/13/iOS-AboutLock/"/>





  <title>iOS-å…³äºé”çš„æ€»ç»“ | Tr2e's Blog</title>
  








<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Tr2e's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            åˆ†ç±»
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            å½’æ¡£
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            å…³äº
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/13/iOS-AboutLock/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Tr2e">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tr2e's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">iOS-å…³äºé”çš„æ€»ç»“</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2019-11-13T22:18:18+08:00">
                2019-11-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å¯¹äºiOSä¸­å„ç§é”çš„å­¦ä¹ æ€»ç»“ï¼Œä¾›æ—¥åæŸ¥é˜…</p>
<a id="more"></a>

<h2 id="å¼•å­"><a href="#å¼•å­" class="headerlink" title="å¼•å­"></a>å¼•å­</h2><p>æ—¥å¸¸å¼€å‘ä¸­ï¼Œ<code>@property (nonatomic, strong) *foo</code>æ˜¯æˆ‘ä»¬ä¸åŒå…¶çƒ¦çš„ä½¿ç”¨é¢‘ç‡æœ€é«˜çš„å£°æ˜æ–¹å¼ï¼Œä¹Ÿå¾ˆæ¸…æ¥š<code>atomic</code>å’Œ<code>nonatomic</code>å±æ€§çš„åŒºåˆ«ï¼Œè¿™é‡Œå†å¤ä¹ ä¸€ä¸‹è¿™ä¸¤ä¸ªå…³é”®å­—ï¼š</p>
<ul>
<li><code>atomic</code>:åŸå­æ€§ï¼Œè¿™ä¸ªå±æ€§æ˜¯é»˜è®¤çš„ï¼Œé€šè¿‡åœ¨<code>setter</code>ã€<code>getter</code>ä¸­åŠ é”ä¿è¯æ•°æ®çš„è¯»å†™å®‰å…¨</li>
<li><code>nonatomic</code>:éåŸå­æ€§ï¼Œå°±æ˜¯ä¸åŠ é”ã€‚ä¼˜ç‚¹æ˜¯é€Ÿåº¦ä¼˜äºä½¿ç”¨<code>atomic</code>ï¼Œå¤§å¤šæ•°åœºæ™¯ä¸ä¼šå‡ºç°é—®é¢˜</li>
</ul>
<p>ä½œä¸ºç¼–è¯‘å™¨æ ‡è¯†ç¬¦ï¼Œ<code>@property</code>çš„ä½œç”¨æ˜¯å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿç”Ÿæˆ<em>æˆå‘˜å˜é‡åŠå…¶getter/setter</em>æ–¹æ³•ï¼Œå¹¶é€šè¿‡å±æ€§å…³é”®å­—ï¼Œå¸®åŠ©æˆ‘ä»¬ç®¡ç†å†…å­˜åŠå®‰å…¨ç­‰ç¹æ‚çš„äº‹åŠ¡ï¼Œé‚£ä¹ˆ<code>atomic</code>æ˜¯å¦‚ä½•å¸®åŠ©æˆ‘ä»¬ä¿è¯æˆå‘˜å˜é‡çš„è¯»å†™å®‰å…¨å‘¢ï¼Ÿä¸‹é¢æˆ‘ä»¬çœ‹ä¸€æ®µä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;@property(retain) UITextField *userName;</span><br><span class="line">&#x2F;&#x2F;ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</span><br><span class="line">- (UITextField *) userName &#123;</span><br><span class="line">    UITextField *retval &#x3D; nil;</span><br><span class="line">    @synchronized(self) &#123;</span><br><span class="line">        retval &#x3D; [userName retain];</span><br><span class="line">        _userName &#x3D; retval;</span><br><span class="line">    &#125;</span><br><span class="line">    return retval;</span><br><span class="line">&#125;</span><br><span class="line">- (void) setUserName:(UITextField *)userName &#123;</span><br><span class="line">    @synchronized(self) &#123;</span><br><span class="line">      [_userName release];</span><br><span class="line">      _userName &#x3D; [userName retain];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„çœ‹å‡ºï¼Œç¼–è¯‘å™¨æ˜¯é€šè¿‡åŠ é”ï¼Œæ¥ä¿è¯å½“å‰æˆå‘˜å˜é‡<code>_userName</code>çš„è¯»å†™å®‰å…¨ï¼Œä¸è‡³äºç”Ÿæˆè„æ•°æ®ï¼Œè¿™ä¾¿æ˜¯<code>atomic</code>èƒŒåï¼Œç¼–è¯‘å™¨å¸®æˆ‘ä»¬åšçš„äº‹æƒ…ã€‚äº‹å®ä¸Šï¼Œå¦‚æœæ·±ç©¶ä¸‹å»ç¼–è¯‘å™¨å¸®æˆ‘ä»¬åŠ äº†ä»€ä¹ˆé”ï¼Œå…¶å®å¹¶é<code>@synchronized(object)</code></p>
<blockquote>
<p><em>è‡ªæ—‹é”</em>ä¸ä¼šä½¿çº¿ç¨‹çŠ¶æ€å‘ç”Ÿåˆ‡æ¢ï¼Œä¸€ç›´å¤„äºç”¨æˆ·æ€ï¼Œå³çº¿ç¨‹ä¸€ç›´éƒ½æ˜¯activeï¼›ä¸ä¼šä½¿çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œå‡å°‘äº†ä¸å¿…è¦çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæ‰§è¡Œé€Ÿåº¦å¿«<br><em>éè‡ªæ—‹é”</em>åœ¨è·å–ä¸åˆ°é”çš„æ—¶å€™ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œä»è€Œè¿›å…¥å†…æ ¸æ€ï¼Œå½“è·å–åˆ°é”çš„æ—¶å€™éœ€è¦ä»å†…æ ¸æ€æ¢å¤ï¼Œéœ€è¦çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢,å½±å“é”çš„æ€§èƒ½</p>
</blockquote>
<p>ä¸ºä»€ä¹ˆ<code>atomic</code>ä¼šåšä¸ºé»˜è®¤å±æ€§ï¼Œæˆ‘ä»¬ä¸éš¾çœ‹å‡ºï¼Œè‹¹æœè¿™ä¹ˆè®¾è®¡æ˜¯æƒ³å‘Šè¯‰æˆ‘ä»¬ï¼Œå¾ˆå¤šæƒ…å†µä¸‹ï¼Œæ•ˆç‡æ¢å®‰å…¨æ˜¯å€¼å¾—çš„</p>
<h2 id="å¦‚ä½•ä½¿ç”¨é”"><a href="#å¦‚ä½•ä½¿ç”¨é”" class="headerlink" title="å¦‚ä½•ä½¿ç”¨é”"></a>å¦‚ä½•ä½¿ç”¨é”</h2><p>ä¸‹é¢ä¸€æ®µç®€å•ä»£ç ï¼Œè€ƒè™‘ä¸€ä¸‹è¾“å‡ºç»“æœ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (void)unlockTest &#123;</span><br><span class="line">    NSMutableString *string &#x3D; [@&quot;Mike&quot; mutableCopy];</span><br><span class="line">    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, 0), ^&#123;</span><br><span class="line">        [string appendString:@&quot;-Locked&quot;];</span><br><span class="line">        NSLog(@&quot;%@&quot;,string);</span><br><span class="line">    &#125;);</span><br><span class="line">    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</span><br><span class="line">        [string appendString:@&quot;-JailBreaked&quot;];</span><br><span class="line">        NSLog(@&quot;%@&quot;,string);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¹¦å†™è¿™æ ·ä¸€æ®µä»£ç ï¼Œæ˜¯æƒ³åœ¨ä¸åŒçº¿ç¨‹ä¸­åœ¨æ”¹å˜å˜é‡åï¼Œä½¿ç”¨è¿™ä¸ªå˜é‡</p>
<p>æ§åˆ¶å°è¾“å‡ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2019-11-11 16:52:43.019128+0800 DiscoverLock_iOS[89763:11225442] Mike-Locked-JailBreaked</span><br><span class="line">2019-11-11 16:52:43.019128+0800 DiscoverLock_iOS[89763:11225441] Mike-Locked-JailBreaked</span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¾ç„¶ä¸æ˜¯æƒ³è¦çš„ç»“æœï¼Œå¦‚ä½•ä¿è¯æˆ‘ä»¬åœ¨ä¸åŒçº¿ç¨‹ä¸­ä½¿ç”¨çš„å˜é‡ï¼Œéƒ½æ˜¯æˆ‘ä»¬å¸Œæœ›çš„å€¼å‘¢ï¼Ÿç­”æ¡ˆä¹‹ä¸€ï¼Œå°±æ˜¯åŠ é”</p>
<h3 id=""><a href="#" class="headerlink" title=""></a><NSLocking></h3><p>OCä¸ºæˆ‘ä»¬æä¾›äº†å››ç§éµå¾ª<NSLocking>çš„ç±»ï¼Œåˆ†åˆ«æ˜¯<code>NSLock</code>/<code>NSCondtionLock</code>/<code>NSRecursiveLock</code>/<code>NSCondition</code>ï¼Œæ»¡è¶³é¢å‘å¯¹è±¡ç¼–ç¨‹çš„éœ€æ±‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@protocol NSLocking</span><br><span class="line"></span><br><span class="line">- (void)lock;&#x2F;&#x2F; é˜»å¡çº¿ç¨‹ï¼Œçº¿ç¨‹ä¼‘çœ </span><br><span class="line">- (void)unlock;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p><strong>åŠ é”çš„åŸºæœ¬æµç¨‹ï¼š ã€åŠ é”ã€‘-&gt;ã€æ“ä½œã€‘-&gt;ã€è§£é”ã€‘</strong><br>ä»¥ä¸Šæåˆ°çš„4ä¸ªç±»ï¼Œå‡å¯ä»¥å®ç°è¿™ä¸ªåŸºç¡€åŠŸèƒ½ï¼Œä¸‹æ–‡ä¸­ä¸å†èµ˜è¿°</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">- (void)lockedTest &#123;</span><br><span class="line">    NSMutableString *string &#x3D; [@&quot;Mike&quot; mutableCopy];</span><br><span class="line">    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, 0), ^&#123;</span><br><span class="line">        &#x2F;&#x2F; [é” lock];</span><br><span class="line">        [string appendString:@&quot;-Locked&quot;];</span><br><span class="line">        NSLog(@&quot;%@&quot;,string);</span><br><span class="line">        &#x2F;&#x2F; [é” unlock];</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</span><br><span class="line">        &#x2F;&#x2F; [é” lock];</span><br><span class="line">        [string appendString:@&quot;-JailBreaked&quot;];</span><br><span class="line">        NSLog(@&quot;%@&quot;,string);</span><br><span class="line">        &#x2F;&#x2F; [é” unlock];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ§åˆ¶å°è¾“å‡ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DiscoverLock_iOS[90562:11303793] Mike-Locked</span><br><span class="line">DiscoverLock_iOS[90562:11303799] Mike-Locked-JailBreaked</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DiscoverLock_iOS[90562:11303793] Mike-JailBreaked</span><br><span class="line">DiscoverLock_iOS[90562:11303799] Mike-JailBreaked-Locked</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„è¾“å‡ºï¼Œç»“æœä¸å¤ªä¸€æ ·ï¼Œä¾§é¢è¯´æ˜äº†<code>DISPATCH_QUEUE_PRIORITY</code>å¹¶ä¸èƒ½ä¿è¯çº¿ç¨‹çš„æ‰§è¡Œé¡ºåºï¼Œå¦‚æœè¦æ˜ç¡®æ‰§è¡Œé¡ºåºï¼Œå±äºçº¿ç¨‹åŒæ­¥çš„èŒƒç•´ï¼Œæœ¬æ–‡ä¸å±•å¼€è®¨è®ºï¼Œåªä¼šåœ¨<strong>NSConditionLock</strong>éƒ¨åˆ†ç®€å•ç¤ºä¾‹å¦‚ä½•ä½¿ç”¨è¯¥ç±»åšåˆ°åŒæ­¥</p>
<h4 id="NSLock"><a href="#NSLock" class="headerlink" title="NSLock"></a>NSLock</h4><ul>
<li><code>- (BOOL)tryLock;</code>:å°è¯•åŠ é”ï¼Œå¦‚æœå¤±è´¥è¿”å›NOï¼Œä¸ä¼šé˜»å¡çº¿ç¨‹</li>
<li><code>- (BOOL)lockBeforeDate:(NSDate *)limit;</code>:æŒ‡å®šæ—¶é—´å‰å°è¯•åŠ é”ï¼Œå¦‚æœå¤±è´¥è¿”å›NOï¼Œåˆ°æ—¶é—´å‰é˜»å¡çº¿ç¨‹</li>
</ul>
<p>ç¤ºä¾‹ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">- (void)lockTest &#123;</span><br><span class="line"></span><br><span class="line">    NSMutableString *string &#x3D; [@&quot;Mike&quot; mutableCopy];</span><br><span class="line">    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, 0), ^&#123;</span><br><span class="line">    LOCK(</span><br><span class="line">         [string appendString:@&quot;-Locked&quot;];</span><br><span class="line">         NSLog(@&quot;%@&quot;,string);</span><br><span class="line">         sleep(5);</span><br><span class="line">        )</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</span><br><span class="line">    TRYLOCK(</span><br><span class="line">            [string appendString:@&quot;-UnLock&quot;];</span><br><span class="line">            NSLog(@&quot;%@&quot;,string);</span><br><span class="line">            sleep(3);</span><br><span class="line">        )</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, 0), ^&#123;</span><br><span class="line">    TRYLOCKINDURATION(2,</span><br><span class="line">                      [string appendString:@&quot;-Ending&quot;];</span><br><span class="line">                      NSLog(@&quot;%@&quot;,string);</span><br><span class="line">                      );</span><br><span class="line">    NSLog(@&quot;-&#x3D;-&#x3D;-&#x3D;-&#x3D;-&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ§åˆ¶å°è¾“å‡ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2019-11-11 19:54:08.807763+0800 DiscoverLock_iOS[92986:11465678] Mike-Locked</span><br><span class="line">2019-11-11 19:54:08.807763+0800 DiscoverLock_iOS[92986:11465679] TryLock-NO</span><br><span class="line">2019-11-11 19:54:08.807889+0800 DiscoverLock_iOS[92986:11465679] Mike-Locked-UnLock</span><br><span class="line">2019-11-11 19:54:10.810165+0800 DiscoverLock_iOS[92986:11465677] TryLockBefore-NO</span><br><span class="line">2019-11-11 19:54:10.810523+0800 DiscoverLock_iOS[92986:11465677] Mike-Locked-UnLock-Ending</span><br><span class="line">2019-11-11 19:54:10.810810+0800 DiscoverLock_iOS[92986:11465677] -&#x3D;-&#x3D;-&#x3D;-&#x3D;-</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡ä¸Šé¢ç¤ºä¾‹ä»£ç è¾“å‡ºå¯ä»¥çœ‹åˆ°ï¼Œ<code>- (BOOL)tryLock;</code>å¹¶ä¸ä¼šé˜»å¡çº¿ç¨‹ï¼Œåœ¨å°è¯•åŠ é”å¤±è´¥æ—¶ï¼Œç«‹å³è¿”å›äº†<strong>NO</strong>,ä½†æ˜¯<code>- (BOOL)lockBeforeDate:(NSDate *)limit;</code>åˆ™åœ¨æ—¶é—´åˆ°ä¹‹å‰é˜»å¡äº†çº¿ç¨‹æ“ä½œï¼Œåœ¨ç­‰å¾…ç›¸åº”æ—¶é—´åï¼Œè¿”å›äº†<strong>NO</strong>ï¼Œå¹¶æ‰§è¡Œäº†ä¸‹ä¸€å¥æ‰“å°ï¼Œå¾ˆæ˜æ˜¾æ˜¯åœ¨ç­‰å¾…æœŸé—´é˜»å¡äº†çº¿ç¨‹</p>
<p>ä¸Šé¢ä»£ç ä¸­ç”¨åˆ°çš„å‡ ä¸ªå®å®šä¹‰ï¼Œå»ºè®®ä»¥åä½¿ç”¨é”æ—¶ï¼Œå°½é‡ä¿æŒå¤´è„‘æ¸…é†’æˆ–è€…å¹²è„†å®šä¹‰ä¸€äº›ä¾¿åˆ©æ–¹æ³•ï¼Œä¿è¯ã€ä¸Šé”ã€‘-ã€è§£é”ã€‘çš„æˆå¯¹å‡ºç°ï¼Œé¿å…çº¿ç¨‹é˜»å¡æˆ–æ­»é”çš„æƒ…å†µ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#define LOCK(...) \</span><br><span class="line">[_lock lock]; \</span><br><span class="line">__VA_ARGS__; \</span><br><span class="line">[_lock unlock]; \</span><br><span class="line"></span><br><span class="line">#define TRYLOCK(...) \</span><br><span class="line">BOOL locked &#x3D; [_lock tryLock]; \</span><br><span class="line">NSLog(@&quot;%@&quot;,locked?@&quot;TryLock-YES&quot;:@&quot;TryLock-NO&quot;); \</span><br><span class="line">__VA_ARGS__; \</span><br><span class="line">if (locked) [_lock unlock]; \</span><br><span class="line"></span><br><span class="line">#define TRYLOCKINDURATION(duration,...) \</span><br><span class="line">BOOL locked &#x3D; [_lock lockBeforeDate:[NSDate dateWithTimeIntervalSinceNow:duration]]; \</span><br><span class="line">NSLog(@&quot;%@&quot;,locked?@&quot;TryLockBefore-YES&quot;:@&quot;TryLockBefore-NO&quot;); \</span><br><span class="line">__VA_ARGS__; \</span><br><span class="line">if (locked) [_lock unlock]; \</span><br></pre></td></tr></table></figure>

<h4 id="NSConditionLock"><a href="#NSConditionLock" class="headerlink" title="NSConditionLock"></a>NSConditionLock</h4><ul>
<li><code>- (instancetype)initWithCondition:(NSInteger)condition NS_DESIGNATED_INITIALIZER;</code>:ä¾¿åˆ©æ„é€ æ–¹æ³•ï¼Œä¼ å…¥æ¡ä»¶é”çš„åˆå§‹å€¼</li>
<li><code>@property (readonly) NSInteger condition;</code>:å½“å‰æ¡ä»¶é”çš„å€¼</li>
<li><code>- (void)lockWhenCondition:(NSInteger)condition;</code>:å½“é”çš„æ¡ä»¶å€¼ä¸ä¼ å…¥å€¼ç›¸ç­‰æ—¶ï¼Œæ‰§è¡Œæ¥ä¸‹æ¥çš„æ“ä½œï¼Œå¦åˆ™é˜»å¡çº¿ç¨‹</li>
<li><code>- (BOOL)tryLock;</code>:å°è¯•åŠ é”ï¼Œå¦‚æœå¤±è´¥è¿”å›NOï¼Œä¸ä¼šé˜»å¡çº¿ç¨‹</li>
<li><code>- (BOOL)tryLockWhenCondition:(NSInteger)condition;</code>:å°è¯•åŠ é”ï¼Œå½“é”çš„æ¡ä»¶å€¼ä¸ä¼ å…¥å€¼ç›¸ç­‰ï¼Œåˆ™åŠ é”æˆåŠŸï¼Œå¦åˆ™å¤±è´¥è¿”å›NOï¼Œä¸ä¼šé˜»å¡çº¿ç¨‹</li>
<li><code>- (void)unlockWithCondition:(NSInteger)condition;</code>:è§£é”æ“ä½œï¼ŒåŒæ—¶å˜æ›´é”çš„æ¡ä»¶å€¼ä¸ºä¼ å…¥å€¼</li>
<li><code>- (BOOL)lockBeforeDate:(NSDate *)limit;</code>:æŒ‡å®šæ—¶é—´å‰å°è¯•åŠ é”ï¼Œå¦‚æœå¤±è´¥è¿”å›NOï¼Œåˆ°æ—¶é—´å‰é˜»å¡çº¿ç¨‹</li>
<li><code>- (BOOL)lockWhenCondition:(NSInteger)condition beforeDate:(NSDate *)limit;</code>:æŒ‡å®šæ—¶é—´å‰å°è¯•åŠ é”ï¼Œå½“é”çš„æ¡ä»¶å€¼ä¸ä¼ å…¥å€¼ç›¸ç­‰ï¼Œåˆ™åŠ é”æˆåŠŸè¿”å›YESï¼Œå¦åˆ™å¤±è´¥è¿”å›NOï¼Œåˆ°æ—¶é—´å‰é˜»å¡çº¿ç¨‹</li>
</ul>
<p><code>NSConditionLock</code>å’Œ<code>NSLock</code>æ–¹æ³•ç±»ä¼¼ï¼Œå¤šäº†ä¸€ä¸ª<code>condition</code>å±æ€§ï¼Œä»¥åŠæ¯ä¸ªæ“ä½œéƒ½å¤šäº†ä¸€ä¸ªå…³äºconditionå±æ€§çš„æ–¹æ³•ï¼Œ<code>- (void)lockWhenCondition:(NSInteger)condition;</code>åªæœ‰conditionå‚æ•°ä¸åˆå§‹åŒ–æ—¶å€™çš„conditionç›¸ç­‰ï¼Œlockæ‰èƒ½æ­£ç¡®è¿›è¡ŒåŠ é”æ“ä½œã€‚è€Œ<code>- (void)unlockWithCondition:(NSInteger)condition;</code>å¹¶ä¸æ˜¯å½“æ¡ä»¶å€¼ç¬¦åˆæ¡ä»¶æ—¶æ‰è§£é”ï¼Œè€Œæ˜¯è§£é”ä¹‹å,ä¿®æ”¹å½“å‰é”çš„æ¡ä»¶å€¼<br>å‡å¦‚ä¸ä½¿ç”¨conditionç›¸å…³çš„æ–¹æ³•ï¼Œ<code>NSConditionLock</code>åŒ<code>NSLock</code>å¹¶æ— äºŒè‡´</p>
<p>ä¸Šæ–‡ä¸­æˆ‘ä»¬æåˆ°äº†çº¿ç¨‹åŒæ­¥é—®é¢˜ï¼Œè¿™é‡Œä¸€èµ·çœ‹ä¸€ä¸‹ä¸‹é¢è¿™æ®µä»£ç </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">- (void)conditionLockUnordered &#123;</span><br><span class="line">    NSMutableString *conditionString &#x3D; [[NSMutableString alloc] init];</span><br><span class="line">    </span><br><span class="line">    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</span><br><span class="line">        [conditionString appendString:@&quot;-1-&quot;];</span><br><span class="line">        NSLog(@&quot;&gt;&gt;&gt; 1 %@ threadInfo:%@&lt;&lt;&lt;&quot;,conditionString,[NSThread currentThread]);</span><br><span class="line">    &#125;);</span><br><span class="line">    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</span><br><span class="line">        [conditionString appendString:@&quot;-2-&quot;];</span><br><span class="line">        NSLog(@&quot;&gt;&gt;&gt; 2 %@ threadInfo:%@&lt;&lt;&lt;&quot;,conditionString,[NSThread currentThread]);</span><br><span class="line">    &#125;);</span><br><span class="line">    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</span><br><span class="line">        [conditionString appendString:@&quot;-3-&quot;];</span><br><span class="line">        NSLog(@&quot;&gt;&gt;&gt; 3 %@ threadInfo:%@&lt;&lt;&lt;&quot;,conditionString,[NSThread currentThread]);</span><br><span class="line">    &#125;);</span><br><span class="line">    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</span><br><span class="line">        [conditionString appendString:@&quot;-4-&quot;];</span><br><span class="line">        NSLog(@&quot;&gt;&gt;&gt; 4 %@ threadInfo:%@&lt;&lt;&lt;&quot;,conditionString,[NSThread currentThread]);</span><br><span class="line">    &#125;);</span><br><span class="line">    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</span><br><span class="line">        [conditionString appendString:@&quot;-5-&quot;];</span><br><span class="line">        NSLog(@&quot;&gt;&gt;&gt; 5 %@ threadInfo:%@&lt;&lt;&lt;&quot;,conditionString,[NSThread currentThread]);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ§åˆ¶å°è¾“å‡ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2019-11-11 20:34:16.875479+0800 DiscoverLock_iOS[93895:11551560] &gt;&gt;&gt; 2 -1--2--4--3- threadInfo:&lt;NSThread: 0x600003905640&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125;&lt;&lt;&lt;</span><br><span class="line">2019-11-11 20:34:16.875525+0800 DiscoverLock_iOS[93895:11551562] &gt;&gt;&gt; 3 -1--2--4--3- threadInfo:&lt;NSThread: 0x600003903680&gt;&#123;number &#x3D; 6, name &#x3D; (null)&#125;&lt;&lt;&lt;</span><br><span class="line">2019-11-11 20:34:16.875530+0800 DiscoverLock_iOS[93895:11551561] &gt;&gt;&gt; 1 -1--2- threadInfo:&lt;NSThread: 0x600003908bc0&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125;&lt;&lt;&lt;</span><br><span class="line">2019-11-11 20:34:16.875543+0800 DiscoverLock_iOS[93895:11551559] &gt;&gt;&gt; 4 -1--2--4--3- threadInfo:&lt;NSThread: 0x6000039175c0&gt;&#123;number &#x3D; 5, name &#x3D; (null)&#125;&lt;&lt;&lt;</span><br><span class="line">2019-11-11 20:34:16.875628+0800 DiscoverLock_iOS[93895:11551560] &gt;&gt;&gt; 5 -1--2--4--3--5- threadInfo:&lt;NSThread: 0x600003905640&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125;&lt;&lt;&lt;</span><br></pre></td></tr></table></figure>
<p>ä¾ç„¶æ˜¯æ··ä¹±çŠ¶æ€ï¼Œä¸Šæ–‡ä¸­<code>NSLock</code>éƒ¨åˆ†å·²ç»é€šè¿‡åŠ é”ï¼Œæ§åˆ¶äº†è¯»å†™çš„ç¨³å®šæ€§ï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬æƒ³è¦æŒ‰ç…§æ ‡å·ä¾æ¬¡æ‰§è¡Œï¼Œè¯¥å¦‚ä½•æ“ä½œï¼Ÿ</p>
<p>ç†Ÿæ‚‰<code>GCD</code>çš„å°ä¼™ä¼´ä¼šè¯´è¿™è¿˜ä¸ç®€å•ï¼Œ<code>dispatch_barrier</code>è§£åƒæ„ï¼Œå½“ç„¶è¿™ä¹ˆå†™æ²¡é—®é¢˜ï¼Œä½†æ˜¯è¿™é‡Œå¤šè¯´ä¸€å˜´ï¼Œ<code>dispatch_barrier</code>åªèƒ½é’ˆå¯¹åŒä¸€ä¸ªå¹¶å‘é˜Ÿåˆ—èµ·ä½œç”¨ï¼Œæ³¨æ„æ­£ç¡®åˆå§‹åŒ–çš„å§¿åŠ¿<code>dispatch_queue_t thread = dispatch_queue_create(&quot;barrier&quot;, DISPATCH_QUEUE_CONCURRENT);</code>,è€Œä¸æ˜¯å¹²å•¥éƒ½æ˜¯ä¸€å¥<code>dispatch_get_global_queue(0,0)</code>,å¦‚æœä½¿ç”¨Global_Queue,è¿™ä¸ªbarrierå°±åŒæ™®é€šçš„<code>dispatch_async</code>æ²¡ä»€ä¹ˆåŒºåˆ«äº†</p>
<p>æˆ‘ä»¬è¦æ˜¯æƒ³åœ¨ä¸åŒçº¿ç¨‹æå®šé¡ºåºè¿™ä¸ªäº‹å„¿ï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿè¿™ä¸ªæ—¶å€™<code>NSConditionLock</code>è‡ªå¸¦çš„æ¡ä»¶æ–¹æ³•ï¼Œä¾¿èƒ½å¸®ä½ å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œå…·ä½“çœ‹ä¸‹é¢çš„ç¤ºä¾‹ä»£ç </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">- (void)conditionLockOrdered &#123;</span><br><span class="line">    &#x2F;&#x2F; NSConditionLock</span><br><span class="line">    NSInteger conditionTag &#x3D; 0;</span><br><span class="line">    _conditionLock &#x3D; [[NSConditionLock alloc] initWithCondition:conditionTag];</span><br><span class="line">    </span><br><span class="line">    NSMutableString *conditionString &#x3D; [[NSMutableString alloc] init];</span><br><span class="line">    </span><br><span class="line">    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, 0), ^&#123;</span><br><span class="line">        NSLog(@&quot;&gt;&gt;&gt; handle 1 &lt;&lt;&lt;&quot;);</span><br><span class="line">        [_conditionLock lockWhenCondition:conditionTag];</span><br><span class="line">        [conditionString appendString:@&quot;-1-&quot;];</span><br><span class="line">        NSLog(@&quot;&gt;&gt;&gt; 1 %@ threadInfo:%@&lt;&lt;&lt;&quot;,conditionString,[NSThread currentThread]);</span><br><span class="line">        [_conditionLock unlockWithCondition:1];</span><br><span class="line">    &#125;);</span><br><span class="line">    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, 0), ^&#123;</span><br><span class="line">        NSLog(@&quot;&gt;&gt;&gt; handle 2 &lt;&lt;&lt;&quot;);</span><br><span class="line">        [_conditionLock lockWhenCondition:1];</span><br><span class="line">        [conditionString appendString:@&quot;-2-&quot;];</span><br><span class="line">        NSLog(@&quot;&gt;&gt;&gt; 2 %@ threadInfo:%@&lt;&lt;&lt;&quot;,conditionString,[NSThread currentThread]);</span><br><span class="line">        [_conditionLock unlockWithCondition:2];</span><br><span class="line">    &#125;);</span><br><span class="line">    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, 0), ^&#123;</span><br><span class="line">        NSLog(@&quot;&gt;&gt;&gt; handle 3 &lt;&lt;&lt;&quot;);</span><br><span class="line">        [_conditionLock lockWhenCondition:2];</span><br><span class="line">        [conditionString appendString:@&quot;-3-&quot;];</span><br><span class="line">        NSLog(@&quot;&gt;&gt;&gt; 3 %@ threadInfo:%@&lt;&lt;&lt;&quot;,conditionString,[NSThread currentThread]);</span><br><span class="line">        [_conditionLock unlockWithCondition:3];</span><br><span class="line">    &#125;);</span><br><span class="line">    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</span><br><span class="line">        NSLog(@&quot;&gt;&gt;&gt; handle 4 &lt;&lt;&lt;&quot;);</span><br><span class="line">        [_conditionLock lockWhenCondition:3];</span><br><span class="line">        [conditionString appendString:@&quot;-4-&quot;];</span><br><span class="line">        NSLog(@&quot;&gt;&gt;&gt; 4 %@ threadInfo:%@&lt;&lt;&lt;&quot;,conditionString,[NSThread currentThread]);</span><br><span class="line">        [_conditionLock unlockWithCondition:4];</span><br><span class="line">    &#125;);</span><br><span class="line">    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</span><br><span class="line">        NSLog(@&quot;&gt;&gt;&gt; handle 5 &lt;&lt;&lt;&quot;);</span><br><span class="line">        [_conditionLock lockWhenCondition:4];</span><br><span class="line">        [conditionString appendString:@&quot;-5-&quot;];</span><br><span class="line">        NSLog(@&quot;&gt;&gt;&gt; 5 %@ threadInfo:%@&lt;&lt;&lt;&quot;,conditionString,[NSThread currentThread]);</span><br><span class="line">        [_conditionLock  unlock];</span><br><span class="line">        NSLog(@&quot;-&#x3D;-&#x3D;-&#x3D;-&#x3D;-&#x3D;-&#x3D;-&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">    NSLog(@&quot;ğŸº&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ§åˆ¶å°è¾“å‡ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">2019-11-11 20:53:58.237847+0800 DiscoverLock_iOS[94374:11586439] ğŸº</span><br><span class="line">2019-11-11 20:53:58.237862+0800 DiscoverLock_iOS[94374:11586488] &gt;&gt;&gt; handle 1 &lt;&lt;&lt;</span><br><span class="line">2019-11-11 20:53:58.237877+0800 DiscoverLock_iOS[94374:11586489] &gt;&gt;&gt; handle 3 &lt;&lt;&lt;</span><br><span class="line">2019-11-11 20:53:58.237868+0800 DiscoverLock_iOS[94374:11586490] &gt;&gt;&gt; handle 2 &lt;&lt;&lt;</span><br><span class="line">2019-11-11 20:53:58.237887+0800 DiscoverLock_iOS[94374:11586491] &gt;&gt;&gt; handle 4 &lt;&lt;&lt;</span><br><span class="line">2019-11-11 20:53:58.237892+0800 DiscoverLock_iOS[94374:11586495] &gt;&gt;&gt; handle 5 &lt;&lt;&lt;</span><br><span class="line">2019-11-11 20:53:58.238111+0800 DiscoverLock_iOS[94374:11586488] &gt;&gt;&gt; 1 -1- threadInfo:&lt;NSThread: 0x6000014c3380&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125;&lt;&lt;&lt;</span><br><span class="line">2019-11-11 20:53:58.238488+0800 DiscoverLock_iOS[94374:11586490] &gt;&gt;&gt; 2 -1--2- threadInfo:&lt;NSThread: 0x6000014dac40&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125;&lt;&lt;&lt;</span><br><span class="line">2019-11-11 20:53:58.238605+0800 DiscoverLock_iOS[94374:11586489] &gt;&gt;&gt; 3 -1--2--3- threadInfo:&lt;NSThread: 0x6000014daf00&gt;&#123;number &#x3D; 5, name &#x3D; (null)&#125;&lt;&lt;&lt;</span><br><span class="line">2019-11-11 20:53:58.239269+0800 DiscoverLock_iOS[94374:11586491] &gt;&gt;&gt; 4 -1--2--3--4- threadInfo:&lt;NSThread: 0x6000014c6740&gt;&#123;number &#x3D; 6, name &#x3D; (null)&#125;&lt;&lt;&lt;</span><br><span class="line">2019-11-11 20:53:58.239410+0800 DiscoverLock_iOS[94374:11586495] &gt;&gt;&gt; 5 -1--2--3--4--5- threadInfo:&lt;NSThread: 0x6000014c3480&gt;&#123;number &#x3D; 7, name &#x3D; (null)&#125;&lt;&lt;&lt;</span><br><span class="line">2019-11-11 20:53:58.239552+0800 DiscoverLock_iOS[94374:11586495] -&#x3D;-&#x3D;-&#x3D;-&#x3D;-&#x3D;-&#x3D;-</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œä¸åŒçš„çº¿ç¨‹ï¼Œè™½ç„¶è¢«è°ƒåº¦çš„æ—¶æœºä¸åŒï¼Œä½†æ˜¯å› ä¸º<code>NSConditionLock</code>çš„å­˜åœ¨ï¼Œåç»­å¯¹æ•°æ®å…·ä½“çš„æ“ä½œï¼Œæˆ‘ä»¬é¢„æƒ³çš„é¡ºåºå¾—åˆ°äº†ä¿è¯ã€‚è¿™ç§ç”¨æ³•ç¬”è€…å¹¶è®¤ä¸ºåœ¨ä»»åŠ¡è€—æ—¶è¾ƒå°‘çš„æƒ…å†µä¸‹æ²¡æœ‰æ˜æ˜¾é—®é¢˜çš„ï¼Œä½†æ˜¯å‡å¦‚å­˜åœ¨é•¿æ—¶é—´çš„è€—æ—¶æ“ä½œï¼Œè¿˜æ˜¯å»ºè®®ä½¿ç”¨<code>dispatch_barrier</code>ï¼Œå› ä¸ºè¿™æ ·ä¸ä¼šå ç”¨è¿‡å¤šèµ„æº</p>
<h4 id="NSRecursiveLock"><a href="#NSRecursiveLock" class="headerlink" title="NSRecursiveLock"></a>NSRecursiveLock</h4><ul>
<li><code>- (BOOL)tryLock;</code>:å°è¯•åŠ é”ï¼Œå¦‚æœå¤±è´¥è¿”å›NOï¼Œä¸ä¼šé˜»å¡çº¿ç¨‹</li>
<li><code>- (BOOL)lockBeforeDate:(NSDate *)limit;</code>:æŒ‡å®šæ—¶é—´å‰å°è¯•åŠ é”ï¼Œå¦‚æœå¤±è´¥è¿”å›NOï¼Œåˆ°æ—¶é—´å‰é˜»å¡çº¿ç¨‹<br>ApiåŒ<code>NSLock</code>å®Œå…¨ä¸€æ ·ï¼ŒåŒºåˆ«åœ¨äº<code>NSRecursiveLockï¼ˆé€’å½’é”ï¼‰</code>å¯ä»¥åœ¨åŒä¸€çº¿ç¨‹ä¸­é‡å¤åŠ é”è€Œä¸æ­»é”ï¼Œå®ƒä¼šè®°å½•ã€ä¸Šé”ã€‘å’Œã€è§£é”ã€‘çš„æ¬¡æ•°ï¼Œå½“è¿™ä¸¤ä¸ªå€¼å¹³è¡¡æ—¶ï¼Œæ‰ä¼šé‡Šæ”¾é”ï¼Œå…¶ä»–çº¿ç¨‹æ‰å¯ä»¥ä¸Šé”æˆåŠŸ</li>
</ul>
<p>å…ˆçœ‹ä¸‹ä¸€æ®µä»£ç ï¼Œä¼šå­˜åœ¨ä»€ä¹ˆé—®é¢˜ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@property (nonatomic, assign) NSInteger recursiveNum;&#x2F;&#x2F; 5</span><br><span class="line">- (void)test_unrecursiveLock &#123;</span><br><span class="line">    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</span><br><span class="line">        [self recursiveTest];</span><br><span class="line">    &#125;);</span><br><span class="line">    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, 0), ^&#123;</span><br><span class="line">        self.recursiveNum &#x3D; 7;</span><br><span class="line">        NSLog(@&quot;&gt;&gt;&gt; changed %ld &lt;&lt;&lt;&quot;,self.recursiveNum);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)recursiveTest &#123;</span><br><span class="line">    if (self.recursiveNum &gt; 0) &#123;</span><br><span class="line">        self.recursiveNum -&#x3D; 1;</span><br><span class="line">        NSLog(@&quot;&gt;&gt;&gt; %ld &lt;&lt;&lt;&quot;,self.recursiveNum);</span><br><span class="line">        [self recursiveTest];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ§åˆ¶å°è¾“å‡ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">2019-11-11 21:27:13.451703+0800 DiscoverLock_iOS[95105:11645279] &gt;&gt;&gt; 4 &lt;&lt;&lt;</span><br><span class="line">2019-11-11 21:27:13.451709+0800 DiscoverLock_iOS[95105:11645277] &gt;&gt;&gt; changed 7 &lt;&lt;&lt;</span><br><span class="line">2019-11-11 21:27:13.451812+0800 DiscoverLock_iOS[95105:11645279] &gt;&gt;&gt; 6 &lt;&lt;&lt;</span><br><span class="line">2019-11-11 21:27:13.451883+0800 DiscoverLock_iOS[95105:11645279] &gt;&gt;&gt; 5 &lt;&lt;&lt;</span><br><span class="line">2019-11-11 21:27:13.451940+0800 DiscoverLock_iOS[95105:11645279] &gt;&gt;&gt; 4 &lt;&lt;&lt;</span><br><span class="line">2019-11-11 21:27:13.452004+0800 DiscoverLock_iOS[95105:11645279] &gt;&gt;&gt; 3 &lt;&lt;&lt;</span><br><span class="line">2019-11-11 21:27:13.452068+0800 DiscoverLock_iOS[95105:11645279] &gt;&gt;&gt; 2 &lt;&lt;&lt;</span><br><span class="line">2019-11-11 21:27:13.452130+0800 DiscoverLock_iOS[95105:11645279] &gt;&gt;&gt; 1 &lt;&lt;&lt;</span><br><span class="line">2019-11-11 21:27:13.452241+0800 DiscoverLock_iOS[95105:11645279] &gt;&gt;&gt; 0 &lt;&lt;&lt;</span><br></pre></td></tr></table></figure>
<p>åŒæ—¶å­˜åœ¨ä¸¤ä¸ªçº¿ç¨‹ï¼Œå¯¹å·²çŸ¥çš„recursiveNumçš„å€¼è¿›è¡Œå†™æ“ä½œï¼Œå…¶ä¸­ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨é€’å½’è°ƒç”¨ï¼Œå¯¹è¯¥å€¼è¿›è¡Œäº†æ“ä½œï¼Œä½†æ˜¯åŒæ—¶å¦ä¸€ä¸ªçº¿ç¨‹æ”¹å˜äº†è¿™ä¸ªå€¼ï¼Œåœ¨ä¸åŠ é”çš„æƒ…å†µä¸‹ï¼Œè¿™ç§æ“ä½œé—®é¢˜å¾ˆå¤šï¼Œå¦‚æœé€’å½’ä¸­å«æœ‰é‡è¦çš„é€»è¾‘å¤„ç†ï¼Œç«æ€å¯èƒ½å¯¼è‡´æ•´ä¸ªé€»è¾‘æ‰§è¡Œå®Œçš„ç»“æœå¤§æ¦‚ç‡æ˜¯é”™è¯¯çš„ã€‚</p>
<p>å¦‚ä½•è§„é¿è¿™ç§ç«æ€å¯¼è‡´çš„ä¸å¿…è¦çš„é”™è¯¯ï¼Œé¦–å…ˆæˆ‘ä»¬æƒ³åˆ°çš„æ˜¯åŠ é”ï¼Œä½†æ˜¯å¦‚æœé€’å½’åŠ é”çš„è¯ï¼Œçº¿ç¨‹ä¼šé‡å¤åŠ é”ï¼Œå¯¼è‡´æ­»é”ã€‚æ‰€ä»¥è¿™æ—¶å€™å¿…é¡»ä½¿ç”¨<strong>é€’å½’é”</strong>æ¥è§£å†³è¿™ä¸ªé—®é¢˜</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">- (void)test_unrecursiveLock &#123;</span><br><span class="line">    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</span><br><span class="line">        [self recursiveTest];</span><br><span class="line">    &#125;);</span><br><span class="line">    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, 0), ^&#123;</span><br><span class="line">        [_recursiveLock lock];&#x2F;&#x2F; é€’å½’é”</span><br><span class="line">        self.recursiveNum &#x3D; 7;</span><br><span class="line">        NSLog(@&quot;&gt;&gt;&gt; changed %ld &lt;&lt;&lt;&quot;,self.recursiveNum);</span><br><span class="line">        [_recursiveLock unlock];&#x2F;&#x2F; è§£é”</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">- (void)recursiveTest &#123;</span><br><span class="line">    [_recursiveLock lock];&#x2F;&#x2F; é€’å½’é”</span><br><span class="line">    if (self.recursiveNum &gt; 0) &#123;</span><br><span class="line">        self.recursiveNum -&#x3D; 1;</span><br><span class="line">        NSLog(@&quot;&gt;&gt;&gt; %ld &lt;&lt;&lt;&quot;,self.recursiveNum);</span><br><span class="line">        [self recursiveTest];</span><br><span class="line">    &#125;</span><br><span class="line">    [_recursiveLock unlock];&#x2F;&#x2F; è§£é”</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ§åˆ¶å°è¾“å‡ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">2019-11-11 21:34:44.422337+0800 DiscoverLock_iOS[95341:11655990] &gt;&gt;&gt; 4 &lt;&lt;&lt;</span><br><span class="line">2019-11-11 21:34:44.422442+0800 DiscoverLock_iOS[95341:11655990] &gt;&gt;&gt; 3 &lt;&lt;&lt;</span><br><span class="line">2019-11-11 21:34:44.422511+0800 DiscoverLock_iOS[95341:11655990] &gt;&gt;&gt; 2 &lt;&lt;&lt;</span><br><span class="line">2019-11-11 21:34:44.422583+0800 DiscoverLock_iOS[95341:11655990] &gt;&gt;&gt; 1 &lt;&lt;&lt;</span><br><span class="line">2019-11-11 21:34:44.422645+0800 DiscoverLock_iOS[95341:11655990] &gt;&gt;&gt; 0 &lt;&lt;&lt;</span><br><span class="line">2019-11-11 21:34:44.422747+0800 DiscoverLock_iOS[95341:11655992] &gt;&gt;&gt; changed 7 &lt;&lt;&lt;</span><br><span class="line"></span><br><span class="line">------</span><br><span class="line"></span><br><span class="line">2019-11-11 21:37:11.238448+0800 DiscoverLock_iOS[95396:11662426] &gt;&gt;&gt; changed 7 &lt;&lt;&lt;</span><br><span class="line">2019-11-11 21:37:11.238635+0800 DiscoverLock_iOS[95396:11662423] &gt;&gt;&gt; 6 &lt;&lt;&lt;</span><br><span class="line">2019-11-11 21:37:11.238793+0800 DiscoverLock_iOS[95396:11662423] &gt;&gt;&gt; 5 &lt;&lt;&lt;</span><br><span class="line">2019-11-11 21:37:11.238930+0800 DiscoverLock_iOS[95396:11662423] &gt;&gt;&gt; 4 &lt;&lt;&lt;</span><br><span class="line">2019-11-11 21:37:11.239093+0800 DiscoverLock_iOS[95396:11662423] &gt;&gt;&gt; 3 &lt;&lt;&lt;</span><br><span class="line">2019-11-11 21:37:11.239293+0800 DiscoverLock_iOS[95396:11662423] &gt;&gt;&gt; 2 &lt;&lt;&lt;</span><br><span class="line">2019-11-11 21:37:11.239844+0800 DiscoverLock_iOS[95396:11662423] &gt;&gt;&gt; 1 &lt;&lt;&lt;</span><br><span class="line">2019-11-11 21:37:11.239976+0800 DiscoverLock_iOS[95396:11662423] &gt;&gt;&gt; 0 &lt;&lt;&lt;</span><br></pre></td></tr></table></figure>
<p>è™½ç„¶å­˜åœ¨ä¸¤ç§è¾“å‡ºç»“æœï¼Œä½†æ˜¯æˆ‘ä»¬çš„é€’å½’æ“ä½œçš„é€»è¾‘ï¼Œå¯ä»¥å®Œå…¨ä¸å—å¹²æ‰°ï¼Œå¦‚æœéœ€è¦æ§åˆ¶é¡ºåºï¼Œï¼ˆæ•²é»‘æ¿ï¼‰è¦æ€ä¹ˆåšå‘¢ï¼Ÿ</p>
<h4 id="NSCondition"><a href="#NSCondition" class="headerlink" title="NSCondition"></a>NSCondition</h4><ul>
<li><code>- (void)wait;</code>:å½“å‰çº¿ç¨‹ç«‹å³è¿›å…¥ä¼‘çœ çŠ¶æ€</li>
<li><code>- (BOOL)waitUntilDate:(NSDate *)limit;</code>:å½“å‰çº¿ç¨‹ç«‹å³è¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œlimitæ—¶é—´åå”¤é†’</li>
<li><code>- (void)signal;</code>:å”¤é†’waitåè¿›å…¥ä¼‘çœ çš„å•æ¡çº¿ç¨‹</li>
<li><code>- (void)broadcast;</code>:å”¤é†’waitåè¿›å…¥ä¼‘çœ çš„æ‰€æœ‰çº¿ç¨‹ï¼Œè°ƒåº¦</li>
</ul>
<p>æœ‰äº›æƒ…å†µéœ€è¦åè°ƒçº¿ç¨‹ä¹‹é—´çš„æ‰§è¡Œã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªçº¿ç¨‹å¯èƒ½éœ€è¦ç­‰å¾…å…¶ä»–çº¿ç¨‹è¿”å›ç»“æœï¼Œè¿™ä¸ªæ—¶å€™<code>NSCondition</code>å¯èƒ½æ˜¯ä¸ªå¥½é€‰æ‹©</p>
<p>ä¸ºäº†èƒ½ä½“ç°NSConditionçš„ä½œç”¨ï¼Œæˆ‘ä»¬ä¸¾ä¸€ä¸ªå¯èƒ½å¹¶ä¸æ˜¯å¾ˆæ°å½“çš„<strong>ç”Ÿäº§è€…-æ¶ˆè´¹è€…</strong>çš„ä¾‹å­ï¼š<br><strong>æˆ‘ä»¬ç°åœ¨æœ‰ä¸€æ¡æŸ”æ€§ç”Ÿäº§çº¿ï¼Œé™å®šæ¯ä¸ªæ‰¹æ¬¡åªèƒ½ç”Ÿäº§3ä»¶å•†å“ï¼Œè€—æ—¶6sï¼ŒåŒæ—¶å¼€æ”¾ç½‘ç»œè´­ä¹°å¹³å°è®©å¤§å®¶æŠ¢è´­æ‹¼å›¢ï¼Œè®¢å•å¼é”€å”®ï¼Œä¸‰äººæˆå›¢ï¼Œç°åœ¨æœ‰ä¸‰ä½å¤©é€‰ä¹‹å­ <em>Tom/Mike/Lily</em> ä»å…¨çƒåƒä¸‡äººä¸­è„±é¢–è€Œå‡ºï¼ŒæˆåŠŸæˆå›¢ã€‚ä¸ºäº†å¢å¼ºå¯ç©æ€§ï¼Œæ´»åŠ¨æ˜¯ä»å¼€å¯çš„ä¸€åˆ»èµ·ï¼ŒåŒæ—¶å¼€å§‹ç”Ÿäº§å’ŒæŠ¢è´­ï¼Œ3ä»¶åº“å­˜é”€å”®å®Œæˆåï¼Œå†æ¬¡è¿›è¡ŒåŒæ—¶è¿›è¡Œç”Ÿäº§å’ŒæŠ¢è´­æ´»åŠ¨</strong></p>
<p>ä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">@interface Producer : NSObject</span><br><span class="line">@property (nonatomic, assign) BOOL shouldProduce;</span><br><span class="line">@property (nonatomic, strong) NSString *itemName;</span><br><span class="line">@property (nonatomic, strong) NSCondition *condition;</span><br><span class="line">@property (nonatomic, strong) NSMutableArray *collector;</span><br><span class="line"></span><br><span class="line">- (instancetype)initWithConditon:(NSCondition *)condition collector:(NSMutableArray *)collector;</span><br><span class="line">- (void)produce;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation Producer</span><br><span class="line"></span><br><span class="line">- (instancetype)initWithConditon:(NSCondition *)condition collector:(NSMutableArray *)collector&#123;</span><br><span class="line">    </span><br><span class="line">    self &#x3D; [super init];</span><br><span class="line">    if (self) &#123;</span><br><span class="line">        self.condition &#x3D; condition;</span><br><span class="line">        self.collector &#x3D; collector;</span><br><span class="line">        self.shouldProduce &#x3D; NO;</span><br><span class="line">        self.itemName &#x3D; nil;</span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(void)produce&#123;</span><br><span class="line">    self.shouldProduce &#x3D; YES;</span><br><span class="line">    while (self.shouldProduce) &#123;</span><br><span class="line">        NSLog(@&quot;å‡†å¤‡ç”Ÿäº§&quot;);</span><br><span class="line">        [self.condition lock];</span><br><span class="line">        NSLog(@&quot;- p lock -&quot;);</span><br><span class="line">        if (self.collector.count &gt; 0 ) &#123;</span><br><span class="line">            NSLog(@&quot;- p - wait&quot;);</span><br><span class="line">            [self.condition wait];</span><br><span class="line">        &#125;</span><br><span class="line">        NSLog(@&quot;å¼€å§‹ç”Ÿäº§&quot;);</span><br><span class="line">        [self.collector addObject:@&quot;å•†å“1&quot;];</span><br><span class="line">        [self.collector addObject:@&quot;å•†å“2&quot;];</span><br><span class="line">        [self.collector addObject:@&quot;å•†å“3&quot;];</span><br><span class="line">        NSLog(@&quot;ç”Ÿäº§:å•†å“1&#x2F;å•†å“2&#x2F;å•†å“3&quot;);</span><br><span class="line">        sleep(6);</span><br><span class="line">        NSLog(@&quot;ç”Ÿäº§ç»“æŸ&quot;);</span><br><span class="line">        [self.condition broadcast];</span><br><span class="line">        NSLog(@&quot;- p signal -&quot;);</span><br><span class="line">        [self.condition unlock];</span><br><span class="line">        NSLog(@&quot;- p unlock -&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    NSLog(@&quot;-ç»“æŸç”Ÿäº§-&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@interface Consumer : NSObject</span><br><span class="line">@property (nonatomic, assign) BOOL shouldConsumer;</span><br><span class="line">@property (nonatomic, strong) NSCondition *condition;</span><br><span class="line">@property (nonatomic, strong) NSMutableArray *collector;</span><br><span class="line">@property (nonatomic,   copy) NSString *itemName;</span><br><span class="line">- (instancetype)initWithConditon:(NSCondition *)condition collector:(NSMutableArray *)collector name:(NSString *)name;</span><br><span class="line">- (void)consumer;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation Consumer</span><br><span class="line">- (instancetype)initWithConditon:(NSCondition *)condition collector:(NSMutableArray *)collector name:(NSString *)name&#123;</span><br><span class="line">    self &#x3D; [super init];</span><br><span class="line">    if (self) &#123;</span><br><span class="line">        self.condition &#x3D; condition;</span><br><span class="line">        self.collector &#x3D; collector;</span><br><span class="line">        self.shouldConsumer &#x3D; NO;</span><br><span class="line">        self.itemName &#x3D; name;</span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(void)consumer&#123;</span><br><span class="line">    self.shouldConsumer &#x3D; YES;</span><br><span class="line">    while (self.shouldConsumer) &#123;</span><br><span class="line">        NSLog(@&quot;%@-å‡†å¤‡è´­ä¹°&quot;,self.itemName);</span><br><span class="line">        [self.condition lock];</span><br><span class="line">        NSLog(@&quot;- c:%@ lock -&quot;,self.itemName);</span><br><span class="line">        if (self.collector.count &#x3D;&#x3D; 0 ) &#123;</span><br><span class="line">            NSLog(@&quot;- c:%@ wait -&quot;,self.itemName);</span><br><span class="line">            [self.condition wait];</span><br><span class="line">        &#125;</span><br><span class="line">        NSString *item &#x3D; [self.collector objectAtIndex:0];</span><br><span class="line">        NSLog(@&quot;%@-ä¹°å…¥:%@&quot;,self.itemName,item);</span><br><span class="line">        [self.collector removeObjectAtIndex:0];</span><br><span class="line">        sleep(2);</span><br><span class="line">        [self.condition signal];</span><br><span class="line">        NSLog(@&quot;- c:%@ signal -&quot;,self.itemName);</span><br><span class="line">        [self.condition unlock];</span><br><span class="line">        NSLog(@&quot;- c:%@ unlock -&quot;,self.itemName);</span><br><span class="line">    &#125;</span><br><span class="line">    NSLog(@&quot;-%@ç»“æŸè´­ä¹°-&quot;,self.itemName);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; è°ƒç”¨</span><br><span class="line">&#123;</span><br><span class="line">    NSMutableArray *pipeline &#x3D; [NSMutableArray array];</span><br><span class="line">    NSCondition *condition &#x3D; [NSCondition new];</span><br><span class="line">    </span><br><span class="line">    Producer *p &#x3D; [[Producer alloc] initWithConditon:condition collector:pipeline];</span><br><span class="line">    Consumer *c &#x3D; [[Consumer alloc] initWithConditon:condition collector:pipeline name:@&quot;Tom&quot;];</span><br><span class="line">    Consumer *c1 &#x3D; [[Consumer alloc] initWithConditon:condition collector:pipeline name:@&quot;Mike&quot;];</span><br><span class="line">    Consumer *c2 &#x3D; [[Consumer alloc] initWithConditon:condition collector:pipeline name:@&quot;Lily&quot;];</span><br><span class="line">    [[[NSThread alloc] initWithTarget:c selector:@selector(consumer) object:c] start];</span><br><span class="line">    [[[NSThread alloc] initWithTarget:c1 selector:@selector(consumer) object:c] start];</span><br><span class="line">    [[[NSThread alloc] initWithTarget:c2 selector:@selector(consumer) object:c] start];</span><br><span class="line">    [[[NSThread alloc] initWithTarget:p selector:@selector(produce) object:p] start];</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    sleep(15);</span><br><span class="line">    NSLog(@&quot;&lt;-----------------&gt;&quot;);</span><br><span class="line">    p.shouldProduce &#x3D; NO;</span><br><span class="line">    c.shouldConsumer &#x3D; NO;</span><br><span class="line">    c1.shouldConsumer &#x3D; NO;</span><br><span class="line">    c2.shouldConsumer &#x3D; NO;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>éƒ¨åˆ†æ§åˆ¶å°è¾“å‡ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">2019-11-12 17:04:03.662926+0800 DiscoverLock_iOS[7110:12246052] Mike-å‡†å¤‡è´­ä¹°</span><br><span class="line">2019-11-12 17:04:03.662916+0800 DiscoverLock_iOS[7110:12246051] Tom-å‡†å¤‡è´­ä¹°</span><br><span class="line">2019-11-12 17:04:03.662990+0800 DiscoverLock_iOS[7110:12246053] Lily-å‡†å¤‡è´­ä¹°</span><br><span class="line">2019-11-12 17:04:03.663005+0800 DiscoverLock_iOS[7110:12246054] å‡†å¤‡ç”Ÿäº§</span><br><span class="line">2019-11-12 17:04:03.663083+0800 DiscoverLock_iOS[7110:12246053] - c:Lily lock -</span><br><span class="line">2019-11-12 17:04:03.663144+0800 DiscoverLock_iOS[7110:12246053] - c:Lily wait -</span><br><span class="line">2019-11-12 17:04:03.663254+0800 DiscoverLock_iOS[7110:12246052] - c:Mike lock -</span><br><span class="line">2019-11-12 17:04:03.663439+0800 DiscoverLock_iOS[7110:12246052] - c:Mike wait -</span><br><span class="line">2019-11-12 17:04:03.663805+0800 DiscoverLock_iOS[7110:12246051] - c:Tom lock -</span><br><span class="line">2019-11-12 17:04:03.663903+0800 DiscoverLock_iOS[7110:12246051] - c:Tom wait -</span><br><span class="line">2019-11-12 17:04:03.664126+0800 DiscoverLock_iOS[7110:12246054] - p lock -</span><br><span class="line">2019-11-12 17:04:03.664297+0800 DiscoverLock_iOS[7110:12246054] å¼€å§‹ç”Ÿäº§</span><br><span class="line">2019-11-12 17:04:03.664433+0800 DiscoverLock_iOS[7110:12246054] ç”Ÿäº§:å•†å“1&#x2F;å•†å“2&#x2F;å•†å“3</span><br><span class="line">2019-11-12 17:04:09.669735+0800 DiscoverLock_iOS[7110:12246054] ç”Ÿäº§ç»“æŸ</span><br></pre></td></tr></table></figure>
<p>åŸºäºå¤šçº¿ç¨‹å¹¶å‘çš„å·¥ä½œåŸç†ï¼Œé€šè¿‡ä¸Šé¢çš„éƒ¨åˆ†æ‰“å°ç»“æœï¼Œä¹Ÿå¾ˆå®¹æ˜“å¾—åˆ°è¿™ä¸ªç»“è®ºã€‚<strong>ç”±äºä¸ç¬¦åˆè´­ä¹°æ¡ä»¶</strong>ï¼Œ<em>Lily</em>/<em>Mike</em>/<em>Tom</em>éƒ½åªèƒ½é€‰æ‹©<code>wait</code>ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œç”Ÿäº§è€…è·å–åˆ°é”å¹¶æ‰§è¡Œç”Ÿäº§ä»£ç ï¼Œåœ¨ç”Ÿäº§å®Œæˆåï¼Œ<code>broadcast</code>æˆ–è€…<code>signal</code>å‘Šè¯‰å…¶ä»–çº¿ç¨‹ï¼Œå¯ä»¥å”¤é†’çº¿ç¨‹å¹¶ç»§ç»­æ‰§è¡Œæ¶ˆè´¹è€…ç›¸å…³ä»£ç ã€‚<br><code>NSCondition</code>ç›¸è¾ƒäº<code>NSConditionLock</code>çš„ä¸åŒç‚¹åœ¨äºä»–ä¾èµ–çš„æ˜¯å¤–éƒ¨å€¼ï¼Œèƒ½å¤Ÿæ»¡è¶³æ›´å¤šå¤æ‚éœ€æ±‚åœºæ™¯ã€‚<br>å‡å¦‚å°†ä¸Šè¿°ä»£ç ä¸­ç”Ÿäº§è€…çš„<code>broadcast</code>æ›¿æ¢æˆ<code>signal</code>åå‘ç°ï¼Œåœ¨å½“å‰è¿™ç§ç‰¹å®šåœºæ™¯ä¸‹ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•çš„ä½œç”¨ä¼¼ä¹å¹¶æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚è€Œä¸”æ„Ÿå…´è¶£çš„åŒå­¦ï¼Œå¯ä»¥ä½¿ç”¨ä¸Šè¿°ä»£ç å¤šè¿è¡Œå‡ æ¬¡ï¼Œçœ‹çœ‹æ˜¯å¦èƒ½å¤Ÿå¾—å‡ºåŒç¬”è€…ä¸€æ ·çš„çŒœæµ‹ï¼š</p>
<ol>
<li>NSConditionä¼šè‡ªèº«é€šè¿‡é˜Ÿåˆ—ç®¡ç†ååŒä»»åŠ¡çš„è°ƒåº¦</li>
<li>waitçš„ä»»åŠ¡ä¾æ¬¡å…¥ç­‰å¾…é˜Ÿåˆ—</li>
<li>æœªwaitçš„ä»»åŠ¡æ ¹æ®è·å¾—é”çš„é¡ºåºä¾æ¬¡å…¥æ‰§è¡Œé˜Ÿåˆ—</li>
<li>waitä»»åŠ¡çš„ç­‰å¾…é˜Ÿåˆ—ä¼šåœ¨æ‰§è¡Œé˜Ÿåˆ—æ‰§è¡Œå®Œåä¾æ¬¡æ‰§è¡Œå¹¶å…¥æ‰§è¡Œé˜Ÿåˆ—</li>
<li>ç¬¬ä¸€æ¬¡è°ƒåº¦é¡ºåºç¡®å®šåï¼Œåç»­ä»»åŠ¡çš„æ‰§è¡Œï¼ŒæŒ‰ç…§æ‰§è¡Œé˜Ÿåˆ—ç¼“å­˜ä¾æ¬¡å‡ºåˆ—æ‰§è¡Œ<br>è¿™é‡Œä»…åšçŒœæƒ³ï¼Œå…·ä½“å®ç°å¯èƒ½å¹¶éå¦‚æ­¤ï¼Œå¾…å¤§ä½¬æŒ‡ç‚¹è¿·æ´¥æˆ–æœ‰æœºä¼šé¶¸ç¬”è€…è‡ªè¡Œç ”ç©¶</li>
</ol>
<h3 id="OSSpinLock"><a href="#OSSpinLock" class="headerlink" title="OSSpinLock"></a>OSSpinLock</h3><p>çœ‹äº†<code>NSCondition</code>è¿™ä¹ˆä¸ªå¤æ‚çš„ä¸œè¥¿ï¼Œæˆ‘ä»¬çœ‹ç‚¹è½»æ¾çš„ï¼Œ<code>OSSpinLock</code>æ˜¯è‹¹æœåœ¨<strong>iOS10</strong>ä¹‹å‰æä¾›çš„è‡ªæ—‹é”æ–¹æ¡ˆï¼Œä½†æ˜¯å­˜åœ¨ä¼˜å…ˆçº§åè½¬çš„é—®é¢˜ï¼Œè¢«è‹¹æœåºŸå¼ƒï¼Œä»¥å‰æºç ä¸­ä½¿ç”¨<code>OSSpinLock</code>çš„åœ°æ–¹ï¼Œéƒ½è¢«è‹¹æœæ›¿æ¢æˆäº†<code>pthread_mutex</code></p>
<p><img src="https://upload-images.jianshu.io/upload_images/1742463-2acd56eaea585c78.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="è¢«åºŸå¼ƒçš„OSSpinLock.png"><br><img src="https://upload-images.jianshu.io/upload_images/1742463-ae8eb41b371e5c62.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="å®˜æ–¹å¤‡æ³¨.png"></p>
<h3 id="os-unfair-lock"><a href="#os-unfair-lock" class="headerlink" title="os_unfair_lock"></a>os_unfair_lock</h3><p><code>os_unfair_lock</code>æ˜¯<strong>iOS10</strong>ä»¥åæ–°å¢çš„ä½çº§åˆ«åŠ é”æ–¹æ¡ˆï¼Œæœ¬è´¨æ˜¯<strong>äº’æ–¥é”</strong>ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„ï¼Œç›®å‰å¾ˆå¤šæ–‡ç« è®¤ä¸ºä»–æ˜¯ä½œä¸ºæ›¿ä»£<code>OSSpinLock</code>çš„æ–¹æ¡ˆå°±æ˜¯è‡ªæ—‹é”æ˜¯æœ‰é—®é¢˜çš„</p>
<ul>
<li><code>void os_unfair_lock_lock(os_unfair_lock_t lock);</code>:åŠ é”</li>
<li><code>bool os_unfair_lock_trylock(os_unfair_lock_t lock);</code>:å°è¯•åŠ é”ï¼ŒæˆåŠŸè¿”å›trueï¼Œå¤±è´¥è¿”å›false</li>
<li><code>void os_unfair_lock_unlock(os_unfair_lock_t lock);</code>:è§£é”</li>
<li><code>void os_unfair_lock_assert_owner(os_unfair_lock_t lock);</code>:å¦‚æœå½“å‰çº¿ç¨‹æœªæŒæœ‰æŒ‡å®šçš„é”ï¼Œåˆ™è§¦å‘æ–­è¨€</li>
<li><code>void os_unfair_lock_assert_not_owner(os_unfair_lock_t lock);</code>:å¦‚æœå½“å‰çº¿ç¨‹æŒæœ‰æŒ‡å®šçš„é”ï¼Œåˆ™è§¦å‘æ–­è¨€</li>
</ul>
<p>å„æ–¹æ³•åŒå¸¸è§çš„é”æ²¡å¤ªå¤§å·®åˆ«ï¼Œå¯ä»¥çœ‹ä¸‹æ–¹æ³•æ³¨é‡Šï¼Œåªæ˜¯éœ€è¦æ³¨æ„ä¸€ä¸‹åˆå§‹åŒ–æ–¹å¼</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    os_unfair_lock_t unfairLock;</span><br><span class="line">    unfairLock &#x3D; &amp;(OS_UNFAIR_LOCK_INIT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="synchronize-object"><a href="#synchronize-object" class="headerlink" title="@synchronize(object)"></a>@synchronize(object)</h3><p><code>@synchronized(object)</code>æŒ‡ä»¤ä½¿ç”¨ä¼ å…¥çš„å¯¹è±¡ä½œä¸ºè¯¥é”çš„å”¯ä¸€æ ‡è¯†ï¼Œåªæœ‰å½“æ ‡è¯†ç›¸åŒæ—¶ï¼Œæ‰æ»¡è¶³äº’æ–¥<br><code>@synchronized(object)</code>æŒ‡ä»¤å®ç°é”çš„ä¼˜ç‚¹å°±æ˜¯æˆ‘ä»¬ä¸éœ€è¦åœ¨ä»£ç ä¸­æ˜¾å¼çš„åˆ›å»ºé”å¯¹è±¡ï¼Œä¾¿å¯ä»¥å®ç°é”çš„æœºåˆ¶ï¼Œè€Œä¸”ä¸ç”¨æ‹…å¿ƒå¿˜è®°è§£é”<br>ä½¿ç”¨æ–¹æ³•æå…¶å¸¸è§ï¼Œä¸åšç¤ºä¾‹äº†</p>
<h3 id="dispatch-semaphore"><a href="#dispatch-semaphore" class="headerlink" title="dispatch_semaphore"></a>dispatch_semaphore</h3><ul>
<li><code>dispatch_semaphore_t dispatch_semaphore_create(long value);</code>:åˆ›å»ºä¿¡å·é‡ï¼Œä¼ å…¥åˆå§‹å€¼</li>
<li><code>long dispatch_semaphore_wait(dispatch_semaphore_t dsema, dispatch_time_t timeout);</code>:å½“ä¿¡å·&lt;=0æ—¶ï¼Œæ ¹æ®ä¼ å…¥çš„æ—¶é—´é˜»å¡çº¿ç¨‹ï¼›å¦‚æœä¿¡å·&gt;0åˆ™ä¸é˜»å¡çº¿ç¨‹ï¼Œå¹¶å¯¹ä¿¡å·-1å¤„ç†</li>
<li><code>long dispatch_semaphore_signal(dispatch_semaphore_t dsema);</code>:å¯¹ä¿¡å·+1å¤„ç†</li>
</ul>
<p><code>GCD</code>ä¸ºæˆ‘ä»¬æä¾›çš„<strong>ä¿¡å·é‡</strong>ä¹Ÿæ˜¯å¸¸ç”¨çš„åŠ é”æ–¹å¼ï¼Œå¸¸è§ç”¨æ³•æ˜¯åˆå§‹åŒ–ä¿¡å·å€¼ä¸º1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    dispatch_semaphore_t lock &#x3D; dispatch_semaphore_create(1);</span><br><span class="line"></span><br><span class="line">    dispatch_semaphore_wait(lock,DISPATCH_TIME_FOREVER);</span><br><span class="line">    &#x2F;&#x2F; æ“ä½œ</span><br><span class="line">    dispatch_semaphare_signal(lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¸¸è§„æ“ä½œå¤§å®¶éƒ½çŸ¥é“ï¼Œæœ‰å¸¸è§„æ“ä½œï¼Œé‚£ä¹ˆä¸€å®šä¹Ÿæœ‰éå¸¸è§„æ“ä½œï¼Œå¯ä»¥çœ‹ä¸€ä¸‹<code>AFNetwork</code>ç»™æˆ‘ä»¬çš„ç¤ºèŒƒ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">- (NSArray *)tasksForKeyPath:(NSString *)keyPath &#123;</span><br><span class="line">    __block NSArray *tasks &#x3D; nil;</span><br><span class="line">    dispatch_semaphore_t semaphore &#x3D; dispatch_semaphore_create(0);</span><br><span class="line">    [self.session getTasksWithCompletionHandler:^(NSArray *dataTasks, NSArray *uploadTasks, NSArray *downloadTasks) &#123;</span><br><span class="line">        if ([keyPath isEqualToString:NSStringFromSelector(@selector(dataTasks))]) &#123;</span><br><span class="line">            tasks &#x3D; dataTasks;</span><br><span class="line">        &#125; else if ([keyPath isEqualToString:NSStringFromSelector(@selector(uploadTasks))]) &#123;</span><br><span class="line">            tasks &#x3D; uploadTasks;</span><br><span class="line">        &#125; else if ([keyPath isEqualToString:NSStringFromSelector(@selector(downloadTasks))]) &#123;</span><br><span class="line">            tasks &#x3D; downloadTasks;</span><br><span class="line">        &#125; else if ([keyPath isEqualToString:NSStringFromSelector(@selector(tasks))]) &#123;</span><br><span class="line">            tasks &#x3D; [@[dataTasks, uploadTasks, downloadTasks] valueForKeyPath:@&quot;@unionOfArrays.self&quot;];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        dispatch_semaphore_signal(semaphore);</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line"></span><br><span class="line">    return tasks;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>AFURLSessionManager</code>ä¸­ï¼Œåˆå§‹åŒ–ä½¿ç”¨<code>dispatch_semaphore_create(0)</code>ï¼Œåœ¨<code>return tasks;</code>å‰è°ƒç”¨<code>dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</code>é˜»å¡çº¿ç¨‹ï¼Œå¾…blockå°†ç›®æ ‡å€¼èµ‹å€¼åï¼Œæ‰§è¡Œ<code>dispatch_semaphore_signal(semaphore);</code>,æ­¤æ—¶taskså·²ç»æœ‰å€¼ï¼Œçº¿ç¨‹è¢«å”¤é†’åæ­£å¸¸è¿”å›ã€‚å¾ˆç§€</p>
<h3 id="pthread-mutex"><a href="#pthread-mutex" class="headerlink" title="pthread_mutex"></a>pthread_mutex</h3><p>Cè¯­è¨€ä¸‹çš„äº’æ–¥é”æ–¹æ¡ˆï¼Œæ˜¯<NSLocking>åè®®ä¸‹å››ä¸ªç±»çš„åº•å±‚</p>
<p>é”å¸¸ç”¨å‡½æ•°ï¼š</p>
<ul>
<li><code>pthread_mutex_init</code>:åŠ¨æ€åˆå§‹åŒ–äº’æ–¥é‡</li>
<li><code>PTHREAD_MUTEX_INITIALIZER</code>:é™æ€åˆ›å»ºäº’æ–¥é‡</li>
<li><code>pthread_mutex_lock</code>:ç»™ä¸€ä¸ªäº’æ–¥é‡åŠ é”</li>
<li><code>pthread_mutex_trylock</code>:åŠ é”ï¼Œå¦‚æœå¤±è´¥ä¸é˜»å¡</li>
<li><code>pthread_mutex_unlock</code>:è§£é”</li>
<li><code>pthread_mutex_destroy</code>:é”€æ¯é”</li>
</ul>
<p>å‚æ•°é…ç½®å‡½æ•°ï¼š</p>
<ul>
<li><code>pthread_mutexattr_init</code>:åˆå§‹åŒ–å‚æ•°</li>
<li><code>pthread_mutexattr_settype</code>:è®¾ç½®ç±»å‹</li>
<li><code>pthread_mutexattr_setpshared</code>:è®¾ç½®ä½œç”¨åŸŸ</li>
<li><code>pthread_mutexattr_destroy</code>:é”€æ¯å‚æ•°</li>
</ul>
<p>æ¡ä»¶å¸¸è§å‡½æ•°ï¼š</p>
<ul>
<li><code>pthread_cond_init</code>:åŠ¨æ€åˆå§‹åŒ–æ¡ä»¶é‡</li>
<li><code>PTHREAD_COND_INITIALIZER</code>:é™æ€åˆ›å»ºæ¡ä»¶é‡</li>
<li><code>pthread_cond_wait</code>:ä¼ å…¥æ¡ä»¶é‡åŠé”</li>
<li><code>pthread_cond_signal</code>:å”¤é†’å•æ¡çº¿ç¨‹å¹¶åŠ é”</li>
<li><code>pthread_cond_broadcast</code>:å¹¿æ’­å”¤é†’æ‰€æœ‰çº¿ç¨‹</li>
<li><code>pthread_cond_destroy</code>:é”€æ¯æ¡ä»¶</li>
</ul>
<p><strong>ä»¥ä¸Šå‡½æ•°éƒ½æ˜¯æœ‰è¿”å›å€¼çš„ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè‹¥æˆåŠŸåˆ™è¿”å›0ï¼Œå¦åˆ™è¿”å›é”™è¯¯ç¼–å·ï¼Œä¸æ˜¯æˆ‘ä»¬ä¹ æƒ¯ä¸­çš„æˆåŠŸYESå¤±è´¥NO</strong></p>
<p>é”ç±»å‹ï¼š</p>
<ul>
<li><code>PTHREAD_MUTEX_NORMAL</code>:ç¼ºçœå€¼ï¼Œè¿™ç§ç±»å‹çš„äº’æ–¥é”ä¸ä¼šè‡ªåŠ¨æ£€æµ‹æ­»é”ã€‚å¦‚æœä¸€ä¸ªçº¿ç¨‹è¯•å›¾å¯¹ä¸€ä¸ªäº’æ–¥é”é‡å¤é”å®šï¼Œå°†ä¼šå¼•èµ·è¿™ä¸ªçº¿ç¨‹çš„æ­»é”ã€‚å¦‚æœè¯•å›¾è§£é”ä¸€ä¸ªç”±åˆ«çš„çº¿ç¨‹é”å®šçš„äº’æ–¥é”ä¼šå¼•å‘ä¸å¯é¢„æ–™çš„ç»“æœã€‚å¦‚æœä¸€ä¸ªçº¿ç¨‹è¯•å›¾è§£é”å·²ç»è¢«è§£é”çš„äº’æ–¥é”ä¹Ÿä¼šå¼•å‘ä¸å¯é¢„æ–™çš„ç»“æœ</li>
<li><code>PTHREAD_MUTEX_ERRORCHECK</code>:è¿™ç§ç±»å‹çš„äº’æ–¥é”ä¼šè‡ªåŠ¨æ£€æµ‹æ­»é”ã€‚å¦‚æœä¸€ä¸ªçº¿ç¨‹è¯•å›¾å¯¹ä¸€ä¸ªäº’æ–¥é”é‡å¤é”å®šï¼Œå°†ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ä»£ç ã€‚å¦‚æœè¯•å›¾è§£é”ä¸€ä¸ªç”±åˆ«çš„çº¿ç¨‹é”å®šçš„äº’æ–¥é”å°†ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ä»£ç ã€‚å¦‚æœä¸€ä¸ªçº¿ç¨‹è¯•å›¾è§£é”å·²ç»è¢«è§£é”çš„äº’æ–¥é”ä¹Ÿå°†ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ä»£ç </li>
<li><code>PTHREAD_MUTEX_RECURSIVE</code>:å¦‚æœä¸€ä¸ªçº¿ç¨‹å¯¹è¿™ç§ç±»å‹çš„äº’æ–¥é”é‡å¤ä¸Šé”ï¼Œä¸ä¼šå¼•èµ·æ­»é”ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹è¿™ç±»äº’æ–¥é”çš„å¤šæ¬¡é‡å¤ä¸Šé”å¿…é¡»ç”±è¿™ä¸ªçº¿ç¨‹æ¥é‡å¤ç›¸åŒæ•°é‡çš„è§£é”ï¼Œè¿™æ ·æ‰èƒ½è§£å¼€è¿™ä¸ªäº’æ–¥é”ï¼Œåˆ«çš„çº¿ç¨‹æ‰èƒ½å¾—åˆ°è¿™ä¸ªäº’æ–¥é”ã€‚å¦‚æœè¯•å›¾è§£é”ä¸€ä¸ªç”±åˆ«çš„çº¿ç¨‹é”å®šçš„äº’æ–¥é”å°†ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ä»£ç ã€‚å¦‚æœä¸€ä¸ªçº¿ç¨‹è¯•å›¾è§£é”å·²ç»è¢«è§£é”çš„äº’æ–¥é”ä¹Ÿå°†ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ä»£ç ã€‚è¿™ç§ç±»å‹çš„äº’æ–¥é”åªèƒ½æ˜¯è¿›ç¨‹ç§æœ‰çš„ï¼ˆä½œç”¨åŸŸå±æ€§PTHREAD_PROCESS_PRIVATEï¼‰</li>
<li><code>PTHREAD_MUTEX_DEFAULT</code>:å°±æ˜¯NORMALç±»å‹</li>
</ul>
<p>é”ä½œç”¨åŸŸï¼š</p>
<ul>
<li><code>PTHREAD_PROCESS_PRIVATE</code>:ç¼ºçœå€¼ï¼Œä½œç”¨åŸŸä¸ºè¿›ç¨‹å†…</li>
<li><code>PTHREAD_PROCESS_SHARED</code>:ä½œç”¨åŸŸä¸ºè¿›ç¨‹é—´</li>
</ul>
<p>ä½¿ç”¨ç¤ºä¾‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">static pthread_mutex_t c_lock;</span><br><span class="line">- (void)testPthread_mutex &#123;</span><br><span class="line">    pthread_mutexattr_t c_lockAttr;</span><br><span class="line">    pthread_mutexattr_init(&amp;c_lockAttr);</span><br><span class="line">    pthread_mutexattr_settype(&amp;c_lockAttr, PTHREAD_MUTEX_RECURSIVE);</span><br><span class="line">    pthread_mutexattr_setpshared(&amp;c_lockAttr, PTHREAD_PROCESS_PRIVATE);</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_init(&amp;c_lock, &amp;c_lockAttr);</span><br><span class="line">    pthread_mutexattr_destroy(&amp;c_lockAttr);</span><br><span class="line"></span><br><span class="line">    pthread_t thread1;</span><br><span class="line">    pthread_create(&amp;thread1, NULL, _thread1, NULL);</span><br><span class="line">    </span><br><span class="line">    pthread_t thread2;</span><br><span class="line">    pthread_create(&amp;thread2, NULL, _thread2, NULL);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void *_thread1() &#123;</span><br><span class="line">    pthread_mutex_lock(&amp;c_lock);</span><br><span class="line">    printf(&quot;thread 1\n&quot;);</span><br><span class="line">    pthread_mutex_unlock(&amp;c_lock);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void *_thread2() &#123;</span><br><span class="line">    pthread_mutex_lock(&amp;c_lock);</span><br><span class="line">    printf(&quot;thread 2 busy\n&quot;);</span><br><span class="line">    sleep(3);</span><br><span class="line">    printf(&quot;thread 2\n&quot;);</span><br><span class="line">    pthread_mutex_unlock(&amp;c_lock);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ä½¿ç”¨é”çš„æ³¨æ„ç‚¹"><a href="#ä½¿ç”¨é”çš„æ³¨æ„ç‚¹" class="headerlink" title="ä½¿ç”¨é”çš„æ³¨æ„ç‚¹"></a>ä½¿ç”¨é”çš„æ³¨æ„ç‚¹</h2><ol>
<li><p>äº’æ–¥é‡éœ€è¦æ—¶é—´æ¥åŠ é”å’Œè§£é”ã€‚é”ä½è¾ƒå°‘äº’æ–¥é‡çš„ç¨‹åºé€šå¸¸è¿è¡Œå¾—æ›´å¿«ã€‚æ‰€ä»¥ï¼Œäº’æ–¥é‡åº”è¯¥å°½é‡å°‘ï¼Œå¤Ÿç”¨å³å¯ï¼Œæ¯ä¸ªäº’æ–¥é‡ä¿æŠ¤çš„åŒºåŸŸåº”åˆ™å°½é‡å¤§ã€‚</p>
</li>
<li><p>äº’æ–¥é‡çš„æœ¬è´¨æ˜¯ä¸²è¡Œæ‰§è¡Œã€‚å¦‚æœå¾ˆå¤šçº¿ç¨‹éœ€è¦é¢†ç¹åœ°åŠ é”åŒä¸€ä¸ªäº’æ–¥é‡ï¼Œ<br>åˆ™çº¿ç¨‹çš„å¤§éƒ¨åˆ†æ—¶é—´å°±ä¼šåœ¨ç­‰å¾…ï¼Œè¿™å¯¹æ€§èƒ½æ˜¯æœ‰å®³çš„ã€‚å¦‚æœäº’æ–¥é‡ä¿æŠ¤çš„æ•°æ®(æˆ–ä»£ç )åŒ…å«å½¼æ­¤æ— å…³çš„ç‰‡æ®µï¼Œåˆ™å¯ä»¥ç‰¹å¤§çš„äº’æ–¥é‡åˆ†è§£ä¸ºå‡ ä¸ªå°çš„äº’æ–¥é‡æ¥æé«˜æ€§èƒ½ã€‚è¿™æ ·ï¼Œä»»æ„æ—¶åˆ»éœ€è¦å°äº’æ–¥é‡çš„çº¿ç¨‹å‡å°‘ï¼Œçº¿ç¨‹ç­‰å¾…æ—¶é—´å°±ä¼šå‡å°‘ã€‚æ‰€ä»¥ï¼Œäº’æ–¥é‡åº”è¯¥è¶³å¤Ÿå¤š(åˆ°æœ‰æ„ä¹‰çš„åœ°æ­¥)ï¼Œæ¯ä¸ªäº’æ–¥é‡ä¿æŠ¤çš„åŒºåŸŸåˆ™åº”å°½é‡çš„å°‘ã€‚</p>
</li>
</ol>
<h2 id="å‚è€ƒæ–‡æ¡£"><a href="#å‚è€ƒæ–‡æ¡£" class="headerlink" title="å‚è€ƒæ–‡æ¡£"></a>å‚è€ƒæ–‡æ¡£</h2><blockquote>
<p><a href="https://www.xuebuyuan.com/3121962.html" target="_blank" rel="noopener">Posixäº’æ–¥é‡pthread_mutex_t</a><br><a href="https://www.jianshu.com/p/ddbe44064ca4" target="_blank" rel="noopener">iOS å¸¸è§çŸ¥è¯†ç‚¹ï¼ˆä¸‰ï¼‰ï¼šLock</a><br><a href="https://blog.ibireme.com/2016/01/16/spinlock_is_unsafe_in_ios/" target="_blank" rel="noopener">ä¸å†å®‰å…¨çš„ OSSpinLock</a><br><a href="https://stackoverflow.com/questions/1215330/how-does-synchronized-lock-unlock-in-objective-c/6047218#6047218" target="_blank" rel="noopener">How does @synchronized lock/unlock in Objective-C?</a><br><a href="https://www.jianshu.com/p/7288eacbb1a2" target="_blank" rel="noopener">[çˆ†æ ˆçƒ­é—¨ iOS é—®é¢˜] atomic å’Œ nonatomic æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</a><br><a href="">ã€Šé«˜æ€§èƒ½iOSåº”ç”¨å¼€å‘ä¸­æ–‡ç‰ˆã€‹</a></p>
</blockquote>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/iOS/" rel="tag"># iOS</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/11/21/%E9%81%97%E6%86%BE%E4%B8%8E%E5%B8%8C%E6%9C%9B/" rel="next" title="é—æ†¾ä¸å¸Œæœ›">
                <i class="fa fa-chevron-left"></i> é—æ†¾ä¸å¸Œæœ›
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Tr2e</p>
              <p class="site-description motion-element" itemprop="description">Principle & Order</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">æ—¥å¿—</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">åˆ†ç±»</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">æ ‡ç­¾</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#å‰è¨€"><span class="nav-number">1.</span> <span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å¼•å­"><span class="nav-number">2.</span> <span class="nav-text">å¼•å­</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å¦‚ä½•ä½¿ç”¨é”"><span class="nav-number">3.</span> <span class="nav-text">å¦‚ä½•ä½¿ç”¨é”</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#"><span class="nav-number">3.1.</span> <span class="nav-text"></span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#NSLock"><span class="nav-number">3.1.1.</span> <span class="nav-text">NSLock</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#NSConditionLock"><span class="nav-number">3.1.2.</span> <span class="nav-text">NSConditionLock</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#NSRecursiveLock"><span class="nav-number">3.1.3.</span> <span class="nav-text">NSRecursiveLock</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#NSCondition"><span class="nav-number">3.1.4.</span> <span class="nav-text">NSCondition</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OSSpinLock"><span class="nav-number">3.2.</span> <span class="nav-text">OSSpinLock</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#os-unfair-lock"><span class="nav-number">3.3.</span> <span class="nav-text">os_unfair_lock</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#synchronize-object"><span class="nav-number">3.4.</span> <span class="nav-text">@synchronize(object)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dispatch-semaphore"><span class="nav-number">3.5.</span> <span class="nav-text">dispatch_semaphore</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pthread-mutex"><span class="nav-number">3.6.</span> <span class="nav-text">pthread_mutex</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ä½¿ç”¨é”çš„æ³¨æ„ç‚¹"><span class="nav-number">4.</span> <span class="nav-text">ä½¿ç”¨é”çš„æ³¨æ„ç‚¹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å‚è€ƒæ–‡æ¡£"><span class="nav-number">5.</span> <span class="nav-text">å‚è€ƒæ–‡æ¡£</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Tr2e</span>

  
</div>


  <div class="powered-by">ç”± <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">ä¸»é¢˜ &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
